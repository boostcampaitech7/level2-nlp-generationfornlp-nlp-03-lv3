import os
import pickle
from datasets import load_dataset
from rank_bm25 import BM25Okapi
import pandas as pd
from tqdm import tqdm
from huggingface_hub import login
from kiwipiepy import Kiwi
from transformers import BertTokenizer

# Authenticate Hugging Face
login("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")

# Initialize Tokenizers
kiwi = Kiwi()
bert_tokenizer = BertTokenizer.from_pretrained("bert-base-multilingual-cased")


def tokenize_and_save_batches(texts, batch_size=10000, save_dir="tokenized_batches"):
    """
    Tokenize texts in batches, save each batch as a Pickle file, and track progress with tqdm.
    """
    os.makedirs(save_dir, exist_ok=True)  # Ensure save directory exists
    unique_texts = list(set(texts))
    print(f"Found {len(unique_texts)} unique texts out of {len(texts)} total entries.")
    
    for i in tqdm(range(0, len(unique_texts), batch_size), desc="Tokenizing and Saving Batches"):
        batch_texts = unique_texts[i:i + batch_size]
        tokenized_batch = {}

        # Add tqdm for progress tracking within the batch
        for txt in tqdm(batch_texts, desc=f"Processing Batch {i // batch_size + 1}", leave=False):
            try:
                morph_question = kiwi.tokenize(txt)
                morph_question_form = [
                    x.form for x in morph_question if x.tag in ["NNG", "NNP", "NNB", "NR", "NP", "SN", "SH", "SL", "VV", "VA", "XR"]
                ]
                morph_question_form_hf = []
                for x in morph_question_form:
                    morph_question_form_hf.extend(bert_tokenizer.tokenize(x))
            except Exception:
                morph_question_form_hf = [x.form for x in kiwi.tokenize(txt)]
            tokenized_batch[txt] = morph_question_form_hf

        # Save the batch
        batch_file = os.path.join(save_dir, f"batch_{i // batch_size + 1}.pkl")
        with open(batch_file, "wb") as f:
            pickle.dump(tokenized_batch, f)
        
        # Clear memory for the batch
        del tokenized_batch

    print(f"Tokenized batches saved to {save_dir}.")


def load_tokenized_batches(save_dir):
    """
    Load tokenized text batches from Pickle files with tqdm for progress tracking.
    """
    tokenized_texts = {}
    batch_files = sorted(os.listdir(save_dir))
    for batch_file in tqdm(batch_files, desc="Loading Tokenized Batches"):
        with open(os.path.join(save_dir, batch_file), "rb") as f:
            batch = pickle.load(f)
            tokenized_texts.update(batch)
    return tokenized_texts


def bm25_search_in_batches(queries, tokenized_query_batches, tokenized_text_dir, top_n=30):
    """
    Perform BM25 search in batches with tqdm progress tracking.
    """
    tokenized_text_batches = sorted(os.listdir(tokenized_text_dir))
    all_results = []

    for batch_file in tqdm(tokenized_text_batches, desc="Processing BM25 Batches"):
        with open(os.path.join(tokenized_text_dir, batch_file), "rb") as f:
            tokenized_text_batch = pickle.load(f)
        
        # Initialize BM25 for the current batch
        bm25 = BM25Okapi(list(tokenized_text_batch.values()))

        # Perform similarity search for each query
        for query, query_tokens in tqdm(tokenized_query_batches.items(), desc=f"Searching in Batch {batch_file}", leave=False):
            batch_results = bm25.get_top_n(query_tokens, list(tokenized_text_batch.keys()), n=top_n)
            all_results.extend([(query, text) for text in batch_results])

        # Clear BM25 model for the batch
        del bm25

    return all_results


# Step 1: Load Dataset
print("Loading dataset...")
dataset = load_dataset("beomi/kowikitext-qa-ref-detail-preview")
data = pd.DataFrame(dataset['train'])  # Convert to Pandas DataFrame for easier manipulation

# Step 2: Tokenize and Save Texts in Batches
texts = data['text'].tolist()
tokenized_text_dir = "tokenized_batches"
tokenize_and_save_batches(texts, batch_size=10000, save_dir=tokenized_text_dir)

# Step 3: Load Tokenized Text Batches
tokenized_texts = load_tokenized_batches(tokenized_text_dir)

# Step 4: Define Queries and Tokenize in Batches
queries = [
    # 사회문화
    "사회·문화 현상이 갖는 특성을 분석하고 다양한 관점을 적용하여 사회·문화 현상을 설명한다.",
    "사회·문화 현상을 탐구하기 위한 양적 연구 방법과 질적 연구 방법의 특징 및 차이점을 비교한다.",
    "사회·문화 현상의 탐구 과정에서 활용되는 다양한 자료 수집 방법의 유형과 특징을 비교한다.",
    "바람직한 연구 태도와 윤리를 바탕으로 하여 사회·문화 현상에 대한 탐구 절차를 실제 사례에 적용한다.",
    "개인과 사회의 관계를 바라보는 여러 관점을 비교하고 인간의 사회화 과정을 설명한다.",
    "사회적 지위와 역할의 의미를 설명하고 역할 갈등의 원인 및 해결 방안을 탐색한다.",
    "사회 집단 및 사회 조직의 유형과 사례를 조사하고 그 특징을 비교한다.",
    "개인과 사회 구조의 관계 속에서 발생하는 일탈 행동을 다양한 관점에서 분석한다.",
    "문화에 대한 이해를 바탕으로 문화를 바라보는 여러 관점을 설명하고 문화 다양성 존중 및 조화를 추구하는 태도를 가진다.",
    "하위문화의 의미를 주류 문화와의 관계 속에서 설명하고 다양한 하위문화의 특징과 기능을 분석한다.",
    "대중문화의 특징을 대중매체와의 관계 속에서 분석하고 대중문화를 비판적으로 수용하는 태도를 가진다.",
    "문화 변동의 요인과 양상을 탐구하고 문화 변동 과정에서 발생하는 문제에 대한 대처 방안을 모색한다.",
    "기능론과 갈등론을 활용하여 사회 불평등 현상을 설명하고 각 이론의 특징을 비교한다.",
    "사회 이동과 사회 계층 구조의 의미를 설명하고 그 유형과 특징을 분석한다.",
    "다양한 사회 불평등 양상을 조사하고 그와 관련한 차별을 개선하기 위한 방안을 모색한다.",
    "사회 복지의 의미를 설명하고 복지 제도의 유형과 역할 및 한계를 분석한다.",
    "사회 변동을 설명하는 다양한 이론을 비교하고 사회 운동이 사회 변동에 미치는 영향을 분석한다.",
    "세계화 및 정보화로 인한 변화 양상을 설명하고 관련 문제에 대처하는 방안을 모색한다.",
    "저출산·고령화와 다문화적 변화로 인해 대두되는 과제를 제시하고 이에 대한 대응 방안을 모색한다.",
    "전 지구적 수준의 문제와 그 해결 방안을 탐색하고 세계시민으로서 지속가능한 사회를 위해 노력하는 태도를 가진다.",
    # 정치와 법
    "정치의 기능과 법의 이념을 이해하고, 민주주의와 법치주의의 발전 과정을 분석한다.",
    "헌법의 의의와 기능을 이해하고, 우리 헌법의 기본 원리를 탐구한다.",
    "우리 헌법에서 보장하는 기본권의 내용을 분석하고, 기본권 제한의 요건과 한계를 탐구한다.",
    "민주 국가의 정부 형태를 이해하고, 한국 헌법에 나타난 대한민국의 정부 형태를 탐구한다.",
    "입법부, 행정부, 사법부의 역할을 이해하고, 이들 간의 상호 관계를 권력분립의 원리에 기초하여 분석한다.",
    "중앙 정부와의 관계 속에서 지방 자치의 의의를 이해하고, 대한민국 지방 자치의 현실과 과제를 탐구한다.",
    "민주 국가의 정치과정을 분석하고, 시민의 정치 참여의 의의와 유형을 탐구한다.",
    "대의제에서 선거의 중요성과 선거 제도의 유형을 이해하고, 대한민국 선거 제도의 특징과 문제점을 분석한다.",
    "정당, 이익집단과 시민단체, 언론의 의의와 기능을 이해하고, 이를 통한 시민 참여의 구체적인 방법과 한계를 분석한다.",
    "민법의 의의와 기능을 이해하고, 민법의 기본 원리를 탐구한다.",
    "재산 관계(계약, 불법행위)와 관련된 기본적인 법률 내용을 이해하고, 이를 일상생활의 사례에 적용한다.",
    "가족 관계(부부, 부모와 자녀)와 관련된 기본적인 법률 내용을 이해하고, 이를 일상생활의 사례에 적용한다.",
    "형법의 의의와 기능을 죄형법정주의를 중심으로 이해하고, 범죄의 성립 요건과 형벌의 종류를 탐구한다.",
    "형사 절차에서 인권을 보장하는 원칙을 이해하고 이를 실현하기 위한 제도를 탐구한다.",
    "법에 의해 보장되는 근로자의 기본적인 권리를 이해하고, 이를 일상생활의 사례에 적용한다.",
    "오늘날의 국제 관계 변화(세계화 등)를 이해하고 국제 사회에서 국제법이 지닌 의의와 한계를 탐구한다.",
    "국제 문제(안보, 경제, 환경 등)를 이해하고, 이를 해결하기 위해 국제기구들이 수행하는 역할과 활동을 분석한다.",
    "한국의 국제 관계를 이해하고, 외교적 관점에서 한반도를 둘러싼 국제 질서를 분석한다.",
    # 경제
    "사람들의 경제생활에서 희소성이 존재함을 인식하고 합리적 선택의 필요성을 이해한다.",
    "다양한 사례를 통해 비용과 편익을 고려하여 선택하는 능력을 계발하고 매몰 비용은 의사 결정 과정에서 고려하지 않아야 함과 인간은 경제적 유인에 반응함을 인식한다.",
    "경제 문제를 해결하는 다양한 방식의 장단점을 비교하고, 시장경제의 기본 원리와 이를 뒷받침하는 사회 제도를 파악한다.",
    "가계, 기업, 정부 등 각 경제 주체가 국가 경제 속에서 수행하는 기본적인 역할을 이해한다.",
    "시장 가격의 결정과 변동 원리를 이해하고, 수요와 공급의 원리를 노동 시장과 금융 시장 등에 적용한다.",
    "경쟁 시장에서 결정된 시장 균형을 통해 자원 배분의 효율성(총잉여의 극대화)이 이루어짐을 이해한다.",
    "경쟁의 제한, 외부 효과, 공공재와 공유 자원, 정보의 비대칭성 등 시장 실패가 나타나는 요인을 파악한다.",
    "시장 실패 현상을 개선하기 위한 정부의 시장 개입과 그로 인해 나타날 수 있는 문제점을 이해하고 이를 보완할 수 있는 방안을 모색한다.",
    "경제 성장의 의미와 요인을 이해하고 한국 경제의 변화와 경제적 성과를 균형 있는 시각에서 평가한다.",
    "경제의 순환 과정을 이해하고 경제 주체의 지출과 소득으로 국민경제활동 수준을 파악한다.",
    "실업과 인플레이션의 발생 원인과 경제적 영향을 알아보고, 그 해결 방안을 모색한다.",
    "총수요와 총공급을 이용하여 경기 변동을 이해하고 재정 정책과 통화 정책을 통한 경제 안정화 방안을 모색한다.",
    "비교 우위에 따른 특화와 교역을 중심으로 무역 원리를 파악하고, 자유 무역과 보호 무역 정책의 경제적 효과를 이해한다.",
    "외환 시장에서 환율이 결정되는 과정과 환율 변동이 국가 경제 및 개인의 경제생활에 미치는 영향을 파악한다.",
    "상품과 서비스 및 자본의 이동에 따른 국제 수지 변화를 이해한다.",
    "현대 경제생활에서 금융의 의미와 중요성을 인식하고, 현재와 미래의 삶을 위하여 수입, 지출, 신용, 저축, 투자의 의미와 역할을 이해한다.",
    "수입과 지출에 영향을 주는 요인들을 인식하고, 개인 자산과 부채의 합리적인 관리 방법을 파악한다.",
    "자산 관리를 적절하게 하는 능력을 계발하기 위하여 자산 관리의 원칙을 파악하고, 다양한 금융 상품의 특성을 이해하고 비교한다.",
    "개인의 생애 주기를 고려하여 건전한 금융 생활을 위한 장·단기 목표를 수립하고, 자신의 재무 계획을 설계한다.",
    # 세계지리
    "세계화와 지역화가 한 장소나 지역의 정체성의 변화에 영향을 주는 사례를 조사하고, 세계화와 지역화가 공간적 상호작용에 미치는 영향을 파악한다.",
    "동·서양의 옛 세계지도에 나타난 세계관 및 지리 정보의 차이를 조사하고, 오늘날의 세계지도에 표현된 주요 지리 정보들을 옛 세계지도와 비교하여 분석한다.",
    "세계의 권역들을 구분하는 데에 활용되는 주요 지표들을 조사하고, 세계의 권역들을 나눈 기존의 여러 가지 사례들을 비교 분석하여 각각의 특징과 장·단점을 평가한다.",
    "기후 요인과 기후 요소에 대한 기본 이해를 바탕으로 열대 기후의 주요 특징과 요인을 분석한다.",
    "온대 동안 기후와 온대 서안 기후의 특징 및 요인을 서로 비교하고, 이러한 기후 환경에 적응한 인간 생활의 모습을 파악한다.",
    "건조 기후와 냉·한대 기후의 주요 특징을 이해하고, 이러한 기후 환경에서 형성된 주요 지형들을 탐구한다.",
    "지형형성작용에 대한 기본 이해를 바탕으로 세계의 주요 대지형의 분포 특징과 형성 원인을 분석한다.",
    "세계적으로 환경 보존이나 관광의 대상지로 주목받고 있는 주요 사례를 중심으로 카르스트 지형, 화산 지형, 해안 지형 등 여러 가지 특수한 지형들의 형성 과정을 이해한다.",
    "세계의 주요 종교별 특징과 주된 전파 경로를 분석하고, 주요 종교의 성지 및 종교 경관이 지닌 상징적 의미들을 비교하고 해석한다.",
    "세계의 일반적 인구 변천 단계와 그 지역적 차이를 파악하고, 국제적 인구 이주의 주요 사례 및 유형을 도출한다.",
    "세계도시의 선정 기준과 주요 특징을 이해하고, 세계도시체계론과 관련지어 세계도시들 사이의 상호작용과 위계 관계를 탐구한다.",
    "세계 주요 식량 자원의 특성과 분포 특징을 조사하고, 식량 생산 및 그 수요의 지역적 차이에 따른 국제적 이동 양상을 분석한다.",
    "세계 주요 에너지 자원의 특성과 분포 특징을 조사하고, 에너지 생산 및 그 수요의 지역적 차이에 따른 국제적 이동 양상을 분석한다.",
    "몬순 아시아에서 나타나는 전통적 생활 모습을 지역의 자연환경과 관련지어 탐구한다.",
    "몬순 아시아와 오세아니아의 주요 국가의 산업 구조를 지역의 대표적 자원 분포 및 이동과 관련지어 비교 분석한다.",
    "몬순 아시아와 오세아니아의 주요 국가들에서 보이는 민족(인종)이나 종교적 차이를 조사하고, 이로 인한 최근의 지역 갈등과 해결 과제를 파악한다.",
    "건조 아시아와 북아프리카에서 나타나는 전통적 생활 모습을 지역의 자연환경과 관련지어 탐구한다.",
    "건조 아시아와 북아프리카의 주요 국가의 산업 구조를 화석 에너지 자원의 분포와 관련지어 비교 분석한다.",
    "건조 아시아와 북아프리카의 주요 사막화 지역과 요인을 조사하고, 사막화의 진행으로 인한 여러 가지 지역 문제를 파악한다.",
    "유럽과 북부 아메리카의 주요 공업 지역과 그 형성 배경을 조사하고, 최근의 변화 과정을 비교 분석한다.",
    "유럽과 북부 아메리카의 세계적 대도시들을 조사하여 현대 도시의 내부 구조의 특징을 추론한다.",
    "유럽과 북부 아메리카에서 나타나는 정치적 혹은 경제적 지역 통합의 사례를 조사하고, 지역의 통합에 반대하는 분리 운동의 사례와 주요 요인을 탐구한다.",
    "중·남부 아메리카의 주요 국가들에서 나타나는 도시 구조의 특징 및 도시 문제를 지역의 급속한 도시화나 민족(인종)의 다양성과 관련지어 탐구한다.",
    "사하라 이남아프리카의 주요 국가들이 겪고 있는 분쟁 및 저개발의 실태를 파악하고, 그 주요 요인을 식민지 경험이나 민족(인종) 및 종교 차이와 관련지어 추론한다.",
    "사하라 이남아프리카와 중·남부 아메리카에서 나타나는 자원 개발의 주요 사례들을 조사하고 환경 보존이나 자원의 정의로운 분배라는 입장에서 평가한다.",
    "경제의 세계화가 파생하는 효과들이 무엇인지 파악하고, 경제의 세계화에 대응하여 여러 국가들이 공존을 위해 결성한 주요 경제 블록의 형성 배경 및 특징을 비교 분석한다.",
    "지구적 환경 문제에 대처하기 위한 국제적 노력이나 생태 발자국, 가뭄 지수 등의 지표들을 조사하고, 우리가 일상에서 실천할 수 있는 방안들을 제안한다.",
    "세계의 평화와 정의를 위한 지구촌의 주요 노력들을 조사하고, 이에 동참하기 위한 세계시민으로서의 바람직한 가치와 태도에 대해 토론한다.",
    # 한국지리
    "세계 속에서 한국의 위치와 영역의 특성을 파악하고, 독도 주권, 동해 표기 등의 의미와 중요성을 이해한다.",
    "고지도와 고문헌을 통하여 전통적인 국토 인식 사상을 이해하고, 국토 인식의 변화 과정을 설명한다.",
    "다양한 지리 정보의 수집·분석·표현 방법을 이해하고, 지역 조사를 위한 구체적인 답사 계획을 수립한다.",
    "한반도의 형성 과정을 이해하고, 이를 중심으로 한반도 산지 지형의 특징을 설명한다.",
    "하천 유역에 발달하는 지형과 해안에 발달하는 지형의 형성 과정 및 특성을 이해하고, 인간의 간섭에 의해 발생하는 문제점에 대해 토론한다.",
    "화산 및 카르스트 지형 형성 과정과 특징을 파악하고, 이를 중심으로 관광 자원으로 활용되는 지형 경관의 사례를 제시한다.",
    "한국의 기후 특성을 기후 요소 및 기후 요인과 관련지어 설명한다.",
    "다양한 기후 경관을 사례로 기후 특성이 경제 생활 등 주민들의 일상생활에 미치는 영향을 설명한다.",
    "자연재해 및 기후 변화의 현상과 원인, 결과를 조사하고, 인간과 자연환경 간의 지속 가능한 관계에 대해 토론한다.",
    "대한민국 촌락의 최근 변화상을 파악하고, 도시의 발달 과정 및 도시체계의 특성을 탐구한다.",
    "도시의 지역 분화 과정 및 내부 구조의 변화를 이해하고, 대도시권의 형성 및 확대가 주민 생활에 미친 영향을 설명한다.",
    "주요 대도시를 사례로 도시 계획과 재개발 과정이 도시 경관과 주민 생활에 미친 영향에 대해 분석한다.",
    "지역 개발의 영향으로 나타나는 공간 및 환경 불평등과 지역 갈등 문제를 파악하고, 국토 개발 과정이 한국 국토에 미친 영향에 대해 평가한다.",
    "자원의 특성과 공간 분포를 파악하고, 이의 생산과 소비에 따른 문제점 및 해결 방안에 대해 모색한다.",
    "농업 구조 변화의 원인 및 특성을 이해하고, 이로 인해 발생하는 다양한 문제의 해결 방안을 탐구한다.",
    "공업의 발달 및 구조 변동으로 인한 공업 입지와 공업 지역의 변화를 파악하고, 이러한 현상이 지역 경관과 주민의 생활에 미친 영향을 설명한다.",
    "상업 및 서비스 산업의 입지에 영향을 미치는 요인과 최근의 변화상을 파악하고, 교통·통신의 발달이 생산 및 소비 공간에 미치는 영향을 평가한다.",
    "한국 인구 분포의 특성을 파악하고, 인구 구조의 변화 과정을 이해한다.",
    "저출산·고령화 등 인구 문제와 이에 따른 공간적 변화를 파악하고, 이의 해결 방안을 제시한다.",
    "외국인 이주자 및 다문화 가정의 증가와 이로 인한 사회·공간적 변화를 조사·분석한다.",
    "구체적인 사례를 통해 지역의 의미와 지역 구분 기준의 다양성을 이해하고, 학생 스스로 선정한 기준에 의해 한국을 여러 지역으로 구분한다.",
    "북한의 자연환경 및 인문 환경 특성, 북한 개방 지역과 남북 교류의 현황을 파악하고 통일 국토의 미래상을 설계한다.",
    "수도권의 지역 특성 및 공간 구조 변화 과정을 경제적·문화적 측면에서 이해하고, 수도권이 당면하고 있는 문제점 및 이의 해결 방안에 대해 탐구한다.",
    "강원 지방에서 영동·영서 지역의 지역차가 나타나는 원인을 파악하고, 지역의 산업 구조 변화가 주민 생활에 미친 영향을 조사한다.",
    "충청 지방의 지역 구조 변화를 교통 발달, 도시 및 산업 단지 개발 등을 중심으로 설명한다.",
    "호남 지방의 농지 개간 및 주요 간척 사업이 지역 주민의 삶에 미친 영향을 이해하고, 최근의 산업 구조 변화를 파악한다.",
    "영남 지방의 인구 및 산업 분포를 통해 지역의 공간 구조를 파악하고, 이 지역 주요 도시의 특성을 경제적·문화적 측면에서 설명한다.",
    "세계적인 관광지로서 제주도의 자연 및 인문 지리적 특성을 조사하고, 이를 바탕으로 지역 발전의 현안과 전망에 대해 분석한다.",
    # 생활 윤리
    "인간의 삶에서 나타나는 다양한 문제를 윤리적 관점에서 이해하고, 이를 학문으로서 다루는 윤리학의 성격과 특징을 설명할 수 있다.",
    "현대의 윤리 문제를 다루는 새로운 접근법 및 동서양의 다양한 윤리 이론들을 비교·분석하고, 이를 다양한 윤리 문제에 적용하여 윤리적 해결 방안을 도출할 수 있다.",
    "윤리적 삶을 살기 위한 다양한 도덕적 탐구와 윤리적 성찰 과정의 중요성을 인식하고, 도덕적 탐구와 윤리적 성찰을 일상의 윤리 문제에 적용할 수 있다.",
    "삶과 죽음에 대한 다양한 윤리적 문제를 인식하고, 이에 대한 여러 윤리적 입장을 비교·분석하여,인공임신중절·자살·안락사·뇌사의 문제를 자신이 채택한 윤리적 관점으로 설명할 수 있다.",
    "생명의 존엄성에 대한 여러 윤리적 관점을 비교·분석하고, 생명 복제, 유전자 치료, 동물의 권리문제를 윤리적 관점에서 설명하며 자신의 관점을 윤리 이 론을 통해 정당화할 수 있다.",
    "사랑과 성의 의미를 양성 평등의 관점에서 분석하고, 성과 관련된 문제를 여러 윤리 이론을 통해 설명할 수 있으며 가족윤리의 관점에서 오늘날의 가족 해체 현상을 탐구하고 이에 대한 극복 방안을 제시할 수 있다.",
    "직업의 의의를 행복의 관점에서 이해하고, 다양한 직업군에 따른 직업윤리를 제시할 수 있으며 공동체 발전을 위한 청렴한 삶의 필요성을 설명할 수 있다.",
    "공정한 분배를 이룰 수 있는 방안으로서 우대 정책과 이에 따른 역차별 문제를 분배 정의 이론을 통해 비판 또는 정당화할 수 있으며, 사형 제도를 교정적 정의의 관점에서 비판 또는 정당화할 수 있다.",
    "국가의 권위와 의무, 시민의 권리와 의무를 동서양의 다양한 관점에서 설명하고, 민주시민의 자세인 참여의 필요성을 제시할 수 있다.",
    "과학 기술 연구에 대한 다양한 관점을 조사하여 비교·설명할 수 있으며 이를 과학 기술의 사회적 책임 문제에 적용하여 비판 또는 정당화할 수 있다.",
    "정보기술과 매체의 발달에 따른 윤리적 문제들을 제시할 수 있으며 이에 대한 해결 방안을 정보윤리와 매체윤리의 관점에서 제시할 수 있다.",
    "자연을 바라보는 동서양의 관점을 비교·설명할 수 있으며 오늘날 환경 문제의 사례와 심각성을 조사하고, 이에 대한 해결 방안을 윤리적 관점에서 제시할 수 있다.",
    "미적 가치와 윤리적 가치를 예술과 윤리의 관계 차원에서 설명할 수 있으며 대중문화의 문제점을 윤리적 관점에서 비판하고 그 개선 방안을 제시할 수 있다.",
    "의식주 생활과 관련된 윤리적 문제들을 제시하고, 이를 윤리적 관점에서 비판할 수 있으며 윤리적 소비 실천의 필요성을 설명할 수 있다.",
    "문화의 다양성을 존중해야 하는 이유를 다문화 이론의 관점에서 설명하고, 오늘날 종교 갈등을 극복하기 위한 방안을 제시할 수 있다.",
    "사회에서 일어나는 다양한 갈등의 양상을 제시하고, 사회 통합을 위한 구체적인 방안을 제안할 수 있으며 바람직한 소통 행위를 담론윤리의 관점에서 설명하고 일상생활에서 실천할 수 있다.",
    "통일 문제를 둘러싼 다양한 쟁점들을 이해하고, 각각의 쟁점에 대한 자신의 관점을 설명할 수 있으며 남북한의 화해를 위한 개인적·국가적 노력을 구체적으로 제시할 수 있다.",
    "국제 사회의 여러 분쟁들과 국가 간 빈부격차 문제를 윤리적 관점에서 비판적 설명을 할 수 있으며 국제 사회에 대한 책임과 기여 문제를 윤리적 관점 에서 정당화하고 실천 방안을 제시할 수 있다.",
    # 윤리와 사상
    "인간에 대한 다양한 관점을 비교하고, 우리의 삶에서 윤리사상과 사회사상이 필요한 이유를 탐구할 수 있다.",
    "우리의 도덕적 삶에서 한국 및 동·서양의 윤리사상과 사회사상이 하는 역할에 대한 실제적인 사례들을 탐구하고, 윤리사상과 사회사상의 관계를 토론할 수 있다.",
    "동양과 한국의 연원적 윤리사상들을 탐구하고, 이를 인간의 행복 및 사회적 질서와 관련시켜 토론할 수 있다.",
    "선진유교의 전개 과정을 탐구하여 도덕의 성립 근거에 대한 상대되는 입장의 특징과 한계를 토론할 수 있고, 성리학과 양명학을 비교하여 도덕법칙의 탐구방법에 상대되는 입장의 특징과 한계를 토론할 수 있다.",
    "이황과 이이의 심성론·수양론을 비교하여 조선성리학의 특징을 설명할 수 있고, 정약용의 심성론·수양론을 탐구하여 조선성리학의 한계와 실학사상의 의의를 설명할 수 있다.",
    "초기불교에 대한 이해에 근거하여 대승불교의 중관사상과 유식사상의 관계를 설명할 수 있고, 교종과 선종의 깨달음의 방법에 대한 상대되는 입장의 특징과 한계를 토론할 수 있다.",
    "한국불교의 주요 사상들을 이해하고, 이를 통해 한국불교의 윤리적 특징과 현대적 의의를 설명할 수 있다.",
    "노자와 장자 사상을 탐구하여 도가적 세계관의 특징을 이해할 수 있고, 도교의 성립 및 한국 고유사상과의 융합을 조사하여 우리 전통 문화에 미친 영향에 대해 토론할 수 있다.",
    "근대 격변기의 상황에 대처해 나타난 한국 전통윤리사상들의 다양한 대응 노력을 탐구하여 그 의의와 한계를 설명할 수 있고, 동양의 이상적 인간상이 현대사회에서 갖는 의의에 대해 토론할 수 있다.",
    "서양윤리사상의 연원으로서 고대 그리스 사상과 헤브라이즘을 살펴보고, 소피스트의 윤리사상과 소크라테스의 윤리사상을 비교하여 윤리적 상대주의와 윤리적 보편주의의 특징을 설명할 수 있다.",
    "영혼의 정의를 강조하는 플라톤의 윤리사상과 이론 및 실천에서 탁월성을 강조하는 아리스토텔레스의 윤리사상을 비교하여 덕과 행복의 관계를 설명할 수 있다.",
    "행복에 이를 수 있는 방법으로서 쾌락의 추구와 금욕의 삶을 강조하는 윤리적 입장을 비교하여 각각의 특징과 한계를 토론할 수 있다.",
    "그리스도교 윤리사상의 특징을 탐구하고, 고대 그리스 사상이 그리스도교 사상과 결합하여 발전한 자연법 윤리사상에 대해 설명할 수 있다.",
    "도덕적 판단과 행동에 관한 이성과 감정의 역할을 규명하고, 도덕적인 삶을 위한 양자 사이의 바람직한 관계에 대해 토론할 수 있다.",
    "의무론과 칸트의 정언명령, 결과론과 공리주의의 특징을 비교하여 각각의 윤리사상이 갖는 장점과 문제점을 파악할 수 있다.",
    "현대의 실존주의, 실용주의가 주장하는 윤리적 입장들을 이해하고, 우리의 도덕적 삶에 기여하는 바를 설명할 수 있다.",
    "동·서양의 이상사회론들을 비교하여 현대 사회에 주는 시사점을 추론할 수 있다.",
    "국가의 개념과 존재 근거에 대한 주요 사상가들의 주장을 탐구하여 다양한 국가관의 특징을 이해하고, 국가의 역할과 정당성에 대한 비판적이고 체계적인 관점을 제시할 수 있다.",
    "개인과 공동체의 관계, 개인의 권리와 의무, 자유의 의미와 정치 참여에 대한 자유주의와 공화주의의 입장을 비교하여, 개인선과 공동선의 조화를 위한 대안을 모색할 수 있다.",
    "민주주의의 사상적 기원과 근대 자유민주주의를 탐구하고, 참여민주주의와 심의민주주의 등 현대 민주주의 사상들이 제시하는 가치 규범을 이해하여, 바람직한 민주시민의 자세에 대해 토론할 수 있다.",
    "자본주의의 규범적 특징과 기여 및 이에 대한 비판들을 조사하고, 이를 통해 우리 사회가 인간의 존엄과 품격을 보장하는 자본주의 사회로 발전해 갈 수 있는 방향에 대해 토론할 수 있다.",
    "동·서양의 평화사상들을 탐구하여 세계시민주의와 세계시민윤리의 원칙 및 지향을 이해하고, 이를 통해 세계시민이 가져야 할 태도에 대해 성찰할 수 있다.",
    # 세계사
    "세계사의 의미를 이해하고 세계사 학습의 필요성을 인식한다.",
    "인류의 출현을 파악하고, 구석기와 신석기 시대 사람들의 생활 모습을 통해 인류 사회의 발전을 이해한다.",
    "여러 지역에서 탄생한 문명의 내용을 조사하여 공통점과 차이점을 설명한다.",
    "춘추·전국 시대부터 수나라·당나라까지 중국사의 전개 과정과 일본 고대 국가의 형성 과정을 살펴보고, 동아시아 문화권의 성격을 이해한다.",
    "북송의 정치·사회적 변화를 살펴보고, 몽골의 팽창이 아시아와 유럽에 미친 영향을 탐구한다.",
    "명나라·청나라 시대와 에도 시대의 변화를 탐구하여 동아시아 세계의 변동 상황을 파악한다.",
    "서아시아 여러 제국의 성립과 발전을 살펴보고, 이슬람교를 중심으로 이슬람 세계의 형성과 확장을 탐구한다.",
    "고대 인도 왕조들의 성립과 발전을 알아보고, 다양한 종교와 문화가 등장한 배경을 파악함으로써 인도 사회의 성격을 이해한다.",
    "그리스·로마 문명의 특징을 이해하고, 고대 지중해 세계의 형성과 발전에 대해 탐구한다.",
    "서유럽 봉건 사회의 전개 양상을 탐구하고, 르네상스에서 시작된 세계관의 변동을 설명한다.",
    "신항로 개척이 가져온 유럽의 흥기와 절대 왕정의 등장에 대해 탐구하여 유럽 사회의 변화된 모습을 파악한다.",
    "시민 혁명과 국민 국가의 형성 과정을 이해하고, 산업 혁명의 세계사적 의미를 해석한다.",
    "제국주의 열강의 침략과 이에 대항한 아시아·아프리카의 민족 운동에 대해 조사한다.",
    "제1, 2차 세계 대전의 원인과 결과를 알아보고, 세계 평화를 실현하기 위한 방법에 대해 토론한다.",
    "냉전 체제의 배경과 특징을 알아보고, 냉전 종식 이후 세계 질서의 재편에 대해 조사한다.",
    "세계화와 과학·기술 혁명이 가져온 현대 사회의 변화를 파악하고, 지구촌의 갈등과 분쟁을 해결하려는 태도를 기른다.",
    # 동아시아사
    "동아시아 세계의 범위를 파악하고 각국 간의 관계와 교류의 역사를 이해해야 할 필요성을 인식한다.",
    "동아시아의 다양한 자연환경을 배경으로 나타난 삶의 모습을 농경과 목축을 중심으로 파악한다.",
    "구석기·신석기 시대의 유물을 중심으로 동아시아에서 다양한 문화가 발전하였음을 이해한다.",
    "동아시아 지역에서 성립했던 국가들의 발전 과정을 파악한다.",
    "인구 이동이 여러 국가와 정치 집단의 형성, 분열, 통합에 영향을 미쳤음을 설명한다.",
    "조공·책봉을 포함한 동아시아의 다양한 외교 형식이 끼친 영향과 의미를 상호적 관점에서 해석한다.",
    "율령 체제의 특징을 파악하고, 각 지역에서 유교·불교·성리학이 수용되는 과정과 영향을 비교한다.",
    "17세기 전후 동아시아 전쟁의 배경, 전개 과정 및 그 결과로 나타난 각국의 변화를 파악한다.",
    "동아시아 지역의 교역망 발달과 서양과의 교역 확대로 인한 은 유통의 활성화 과정을 이해한다.",
    "인구 증가로 인해 도시와 상업이 발달하고 서민 문화가 융성하였음을 사례를 들어 설명한다.",
    "개항 이후 나타난 국제 관계의 변동을 살펴보고, 동아시아에서 일어난 근대화 운동을 비교한다.",
    "제국주의 침략의 실상과 일본 군국주의로 인한 전쟁의 확대 과정을 살펴보고, 그에 대항한 각국의 민족 운동을 비교하여 설명한다.",
    "동아시아 각국에서 서양 문물의 수용으로 나타난 사회·문화·사상적 변화 사례를 비교한다.",
    "제2차 세계 대전의 전후 처리 과정을 알아보고, 동아시아에서 냉전의 심화·해체 과정과 그 영향을 분석한다.",
    "동아시아 각국에서 나타난 정치·경제·사회적 발전 모습을 비교하여 파악한다.",
    "오늘날 동아시아 국가 간의 갈등과 분쟁 사례를 살펴보고 그 해결을 위해 노력하는 자세를 갖는다.",
    # 한국사
    "고대 국가의 지배 체제 : 고대 국가의 성립・발전 과정을 파악하고, 지배 체제의 성격을 이해한다.",
    "고대 사회의 종교와 사상 : 고대 사회의 종교와 사상을 시기별로 살펴보고, 정치·사회적 기능을 파악한다.",
    "고려의 통치 체제와 국제 질서의 변동 : 고려 시대 통치 체제의 성립과 변화를 국제 질서의 변동과 연결 지어 파악한다.",
    "고려의 사회와 사상 : 다원적인 사회 구조와 다양한 사상적 기반 위에 고려 사회가 운영되었음을 이해한다.",
    "조선 시대 세계관의 변화 : 조선 시대 세계관의 변화를 국내 정치 운영과 국제 질서의 변동 속에서 탐구한다.",
    "양반 신분제 사회와 상품 화폐 경제 : 조선 시대 신분의 구성과 특성을 살펴보고, 양난 이후 상품 화폐 경제가 발달하면서 신분제에 변동이 나타났음을 이해한다.",
    "서구 열강의 접근과 조선의 대응 : 흥선 대원군이 추진한 정책의 내용과 성격을 이해하고, 서구 열강의 침략적 접근에 대한 조선의 대응을 파악한다.",
    "동아시아의 변화와 근대적 개혁의 추진 : 강화도 조약의 성격을 살펴보고, 개화 정책의 내용과 이를 둘러싼 여러 세력의 대응을 다른 나라의 사례와 비교하여 파악한다.",
    "근대 국민 국가 수립을 위한 노력 : 열강의 침략이 가속화되는 가운데 여러 세력이 추진한 근대 국가 수립 노력을 탐색한다.",
    "일본의 침략 확대와 국권 수호 운동 : 일본의 국권 침탈 과정과 이에 맞선 국권 수호 운동의 내용을 파악한다.",
    "개항 이후 경제적 변화 : 개항 이후 열강의 경제 침략과 이로 인한 경제적 변화를 살펴보고, 이를 저지하기 위한 노력을 파악한다.",
    "개항 이후 사회·문화적 변화 : 개항 이후 근대 문물 수용으로 나타난 사회‧문화적 변화를 살펴본다.",
    "일제의 식민지 지배 정책 : 1차 세계 대전 전후 세계 정세의 변화를 살펴보고, 일제의 식민지 지배 정책과 경제 구조 변화의 특징을 파악한다.",
    "3·1 운동과 대한민국 임시 정부 : 3·1 운동의 배경과 전개 과정을 이해하고, 대한민국 임시 정부 수립의 의미를 파악한다.",
    "다양한 민족운동의 전개 : 3·1 운동 이후 나타난 국내외 민족 운동의 흐름을 파악한다.",
    "사회·문화의 변화와 사회 운동 : 사회 모습의 변화를 살펴보고, 다양한 사회 운동을 근대 사상의 확산과 관련지어 이해한다.",
    "전시 동원 체제와 민중의 삶 : 일제의 침략 전쟁 이후 식민지 지배 방식의 변화를 살펴보고, 전시 동원 체제로 달라진 민중의 삶을 사례 중심으로 파악한다.",
    "광복을 위한 노력 : 일제의 침략 전쟁에 맞선 민족 운동의 내용을 파악하고, 신국가 건설에 대한 구상을 탐구한다.",
    "8·15 광복과 통일 정부 수립을 위한 노력 : 8·15 광복 이후의 정치적 상황을 세계 냉전 체제 형성과 관련하여 살펴보고, 통일 정부 수립을 위한 노력을 이해한다.",
    "대한민국 정부의 수립 : 대한민국 정부 수립의 과정과 의의를 살펴보고, 식민지 잔재를 청산하기 위한 노력을 설명한다.",
    "6·25 전쟁과 남북 분단의 고착화 : 6·25 전쟁의 배경과 전개 과정을 살펴보고, 전후 남북 분단이 고착되는 과정을 파악한다.",
    "4·19 혁명과 민주화를 위한 노력 : 4·19 혁명과 그 이후의 정치 변화를 살펴보고, 독재에 맞선 민주화 운동과 그 의미를 탐구한다",
    "경제 성장과 사회․문화의 변화 : 경제 성장의 성과와 문제점을 살펴보고, 이에 따른 사회․문화의 변화를 파악한다.",
    "6월 민주 항쟁과 민주주의의 발전 : 6월 민주 항쟁 이후 평화적 정권 교체가 이루어지고, 시민 사회가 성장하면서 민주주의가 발전하는 과정에 대해 파악한다.",
    "외환위기와 사회·경제적 변화 : 외환 위기를 극복하기 위한 노력을 살펴보고, 이 시기에 당면한 사회적 과제를 탐구한다.",
    "남북 화해와 동아시아 평화를 위한 노력 : 남북 화해의 과정을 살펴보고, 동아시아 평화를 위해 공헌할 수 있는 방안을 생각해본다."
]
tokenize_and_save_batches(queries, batch_size=100, save_dir="query_batches")
tokenized_queries = load_tokenized_batches("query_batches")

# Step 5: Perform BM25 Search
print("Performing BM25 similarity search...")
results = bm25_search_in_batches(queries, tokenized_queries, tokenized_text_dir)

# Step 6: Map Results to Dataset and Save
results_df = pd.DataFrame(results, columns=["query", "text"])
results_df = results_df.merge(data, on="text", how="inner")  # Join with dataset to get full rows
results_df = results_df.drop_duplicates(subset='id', keep='first')  # Remove duplicates
output_file = "bm25_top30_similarities_optimized.csv"
results_df.to_csv(output_file, index=False)

print(f"Results saved to {output_file}")
